name: Auto Update GitHub Activity and Commits

on:
  workflow_dispatch:       # æ‰‹å‹•è§¸ç™¼
  schedule:
    - cron: "0 */6 * * *"  # æ¯ 6 å°æ™‚è‡ªå‹•åŸ·è¡Œ

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    name: ğŸ§¾ Update README activity and commits

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 1: Update recent activity
      - name: Generate GitHub activity log
        uses: Readme-Workflows/recent-activity@main
        env:
          GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}

      # Step 2: Fetch recent commits
      - name: Fetch latest commits
        run: |
          curl -H "Authorization: token ${{ secrets.MY_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/${{ github.repository }}/commits?per_page=5 \
               > commits.json

      # Step 3: Generate markdown section for commits
      - name: Generate commits section
        run: |
          echo "## Recent Commits" > commits.md
          jq -r '.[] | "- [\(.commit.message)](\(.html_url)) by \(.commit.author.name) on \(.commit.author.date))"' commits.json >> commits.md

      # Step 4: Insert commits section into README.md
      - name: Update README.md with commits
        run: |
          # Replace placeholder with commits section
          placeholder_start="<!--START_SECTION:commits-->"
          placeholder_end="<!--END_SECTION:commits-->"
          content=$(cat commits.md | sed ':a;N;$!ba;s/\n/\\n/g')
          # Use perl instead of sed for multiline replacement to avoid YAML issues
          perl -i -0777 -pe "s|$placeholder_start.*?$placeholder_end|$placeholder_start\n$content\n$placeholder_end|s" README.md

      # Step 5: Sync README.md into index.md
      - name: Sync README.md into index.md
        run: |
          echo "---" > index.md
          echo "title: Home" >> index.md
          echo "---" >> index.md
          echo "" >> index.md
          cat README.md >> index.md

      # Step 6: Commit and push
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md index.md
          git commit -m "ğŸ”„ Auto update activity & commits" || echo "No changes to commit"
          git push

  deploy-pages:
    name: ğŸŒ Deploy to GitHub Pages
    needs: update-readme
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload site content
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

